<div class="container">
    <div class="content">
        <h2 class="title">Verifikasi Akun</h2>
        <kirim-otp class="content">
            <h3>Teridentifikasi dengan NIS <span class="setup-akun-selected-id"></span></h3>
        <p>Sepertinya akun ini belum tertaut pada WhatsApp mana pun, silahkan masukan nomor WhatsApp aktif untuk menyiapkan!</p><br>
            <input type="tel" class="nomor_wa" placeholder="628XXXXXXXXXX">
            <button type="button" class="tombol action" actionDo="send-otp">Kirim OTP</button>
        </kirim-otp>
        <balas-otp class="content" style="display: none;">
            <h3>OTP berhasil dikirim ke nomor <b><span class="setup-akun-selected-wa"></span></b></h3>
            <p>OTP akan dikirimkan melalui WhatsApp paling cepat 1 menit.</p><br>
            <input type="number" class="otp_wa" placeholder="XXXXXX">
            <button type="button" class="tombol action" actionDo="verify-otp">Verifikasi</button>
        </balas-otp>
    </div>
    <script>
        $(".setup-akun-selected-id").html(loadData('akun_nis'));
        
        $(document).on('click','.action',function(e){
            let aksi = $(this).attr('actionDo');
            let akun_nis = loadData('akun_nis');
            let akun_wa = $(".nomor_wa").val();
            let akun_otp = $(".otp_wa").val();
            switch (aksi) {
                case 'send-otp':
                $.ajax({
                    url: `${appAPIServer}/account/request`, dataType: "json", method: "POST",
                    data: {
                        nis: akun_nis,
                        nohp: akun_wa
                    },success: function( response ) {
                        if (response.code == 'ok'){
                            alert(`OTP berhasil dikirim!`);
                            setData(akun_wa, 'akun_wa');
                            $(".setup-akun-selected-wa").html(loadData('akun_wa'));
                            $("kirim-otp").hide();
                            $("balas-otp").show();
                        }else{
                            alert(`OTP gagal dikirim, ${response.msg}`);
                        }
                    },
                    error: function(err) {
                        alert(`Error : ${err.status}, ${err.statusText}`);
                    }
                });    
                    break;
                case 'verify-otp':
                $.ajax({
                    url: `${appAPIServer}/account/assign`, dataType: "json", method: "POST",
                    data: {
                        nis: akun_nis,
                        nohp: akun_wa,
                        otp: akun_otp
                    },success: function( response ) {
                        if (response.code == 'ok'){
                            alert(`Verifikasi OTP berhasil, ${response.msg}`);
                            setData(response.sesi, 'akun_sesi');
                            appLoadPage('main');
                        }else{
                            alert(`Verifikasi OTP gagal, ${response.msg}`);
                        }
                    },
                    error: function(err) {
                        alert(`Error : ${err.status}, ${err.statusText}`);
                    }
                });   
                    break;
            }
        });
    </script>
</div>
<script class="loadPageScript">
    // Menghapus page script
    $(".loadPageScript").remove();
</script>